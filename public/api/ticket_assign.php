<?php require_once __DIR__ . '/../../includes/functions.php'; require_once __DIR__ . '/../../includes/csrf.php'; require_login(); require_role('coordinator'); csrf_check();
$id=(int)($_POST['id']??0); $assigned_to=(int)($_POST['assigned_to']??0);
if($id && $assigned_to){ $pdo->prepare("UPDATE tickets SET assigned_to=?, updated_at=NOW() WHERE id=?")->execute([$assigned_to,$id]); log_activity($id,'assigned',['assigned_to'=>$assigned_to]); $ass=$pdo->prepare("SELECT id,email,name,phone FROM users WHERE id=?"); $ass->execute([$assigned_to]); if($a=$ass->fetch()){ notify_inapp($a['id'],"Ticket #$id has been assigned to you", base_url("ticket_view.php?id=$id")); @notify_email($a['email'],$a['name'],"Ticket #$id assigned","<p>Please review the ticket.</p>"); if(!empty($a['phone'])) @notify_sms($a['phone'],"Ticket #$id assigned to you."); } header('Location: ../tickets.php?msg=assigned'); exit; } http_response_code(400); echo 'Bad request';